From 4be9f903c40102380fd2b115644c499a5f2aa826 Mon Sep 17 00:00:00 2001
From: Raine Makelainen <raine.makelainen@jolla.com>
Date: Thu, 7 Dec 2017 13:15:34 +0200
Subject: [PATCH 02/13] Drop smartata dependencies

Signed-off-by: Raine Makelainen <raine.makelainen@jolla.com>
---
 configure.ac              |  4 ----
 src/udiskslinuxdriveata.c | 18 ++++++++++++++++++
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/configure.ac b/configure.ac
index df2ffaa2..47e50036 100644
--- a/configure.ac
+++ b/configure.ac
@@ -168,10 +168,6 @@ if test "x$enable_daemon" = "xyes"; then
   AC_SUBST(BLOCKDEV_CFLAGS)
   AC_SUBST(BLOCKDEV_LIBS)
 
-  PKG_CHECK_MODULES(LIBATASMART, [libatasmart >= 0.17])
-  AC_SUBST(LIBATASMART_CFLAGS)
-  AC_SUBST(LIBATASMART_LIBS)
-
   PKG_CHECK_MODULES(LIBMOUNT, [mount >= 2.18])
   AC_SUBST(LIBMOUNT_CFLAGS)
   AC_SUBST(LIBMOUNT_LIBS)
diff --git a/src/udiskslinuxdriveata.c b/src/udiskslinuxdriveata.c
index 2de138cd..308d9589 100644
--- a/src/udiskslinuxdriveata.c
+++ b/src/udiskslinuxdriveata.c
@@ -18,6 +18,10 @@
  *
  */
 
+#ifndef HAVE_ATA_SMART
+#define HAVE_ATA_SMART 0
+#endif
+
 #include "config.h"
 #include <glib/gi18n-lib.h>
 
@@ -36,7 +40,9 @@
 #include <glib/gstdio.h>
 #include <errno.h>
 
+#if HAVE_ATA_SMART
 #include <atasmart.h>
+#endif
 
 #include "udiskslogging.h"
 #include "udiskslinuxprovider.h"
@@ -356,6 +362,7 @@ typedef struct
   gint num_attributes_failed_in_the_past;
 } ParseData;
 
+#if HAVE_ATA_SMART
 static void
 parse_attr_cb (SkDisk                           *d,
                const SkSmartAttributeParsedData *a,
@@ -436,6 +443,7 @@ selftest_status_to_string (SkSmartSelfTestExecutionStatus status)
     }
   return ret;
 }
+#endif
 
 static gboolean
 get_pm_state (UDisksLinuxDevice *device, GError **error, guchar *count)
@@ -474,6 +482,7 @@ get_pm_state (UDisksLinuxDevice *device, GError **error, guchar *count)
   return rc;
 }
 
+#if HAVE_ATA_SMART
 static gboolean update_io_stats (UDisksLinuxDriveAta *drive, UDisksLinuxDevice *device)
 {
   const gchar *drivepath = g_udev_device_get_sysfs_path (device->udev_device);
@@ -505,6 +514,7 @@ static gboolean update_io_stats (UDisksLinuxDriveAta *drive, UDisksLinuxDevice *
     }
   return noio;
 }
+#endif
 
 /**
  * udisks_linux_drive_ata_refresh_smart_sync:
@@ -535,6 +545,7 @@ udisks_linux_drive_ata_refresh_smart_sync (UDisksLinuxDriveAta  *drive,
                                            GCancellable         *cancellable,
                                            GError              **error)
 {
+#if HAVE_ATA_SMART
   UDisksLinuxDriveObject *object;
   UDisksLinuxDevice *device = NULL;
   gboolean ret = FALSE;
@@ -693,6 +704,9 @@ udisks_linux_drive_ata_refresh_smart_sync (UDisksLinuxDriveAta  *drive,
     sk_disk_free (d);
   g_clear_object (&object);
   return ret;
+#else
+  return FALSE;
+#endif
 }
 
 /* ---------------------------------------------------------------------------------------------------- */
@@ -719,6 +733,7 @@ udisks_linux_drive_ata_smart_selftest_sync (UDisksLinuxDriveAta  *drive,
                                             GCancellable         *cancellable,
                                             GError              **error)
 {
+#if HAVE_ATA_SMART
   UDisksLinuxDriveObject  *object;
   UDisksLinuxDevice *device = NULL;
   SkDisk *d = NULL;
@@ -775,6 +790,9 @@ udisks_linux_drive_ata_smart_selftest_sync (UDisksLinuxDriveAta  *drive,
     sk_disk_free (d);
   g_clear_object (&object);
   return ret;
+#else
+  return FALSE;
+#endif
 }
 
 /* ---------------------------------------------------------------------------------------------------- */
-- 
2.25.1

