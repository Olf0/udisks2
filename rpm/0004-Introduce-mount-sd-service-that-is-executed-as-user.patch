From b3e3134db4e46273625e530097698ddc31308154 Mon Sep 17 00:00:00 2001
From: Marko Kenttala <marko.kenttala@jolla.com>
Date: Tue, 15 Oct 2019 17:57:19 +0300
Subject: [PATCH 04/13] Introduce mount-sd service that is executed as user

---
 data/80-udisks2.rules  |  5 +++++
 data/Makefile.am       |  1 +
 data/mount-sd@.service | 12 ++++++++++++
 tools/Makefile.am      |  3 +++
 tools/udisksctl-user   |  4 ++++
 5 files changed, 25 insertions(+)
 create mode 100644 data/mount-sd@.service
 create mode 100644 tools/udisksctl-user

diff --git a/data/80-udisks2.rules b/data/80-udisks2.rules
index 39bfa28b..3635a73f 100644
--- a/data/80-udisks2.rules
+++ b/data/80-udisks2.rules
@@ -48,6 +48,11 @@ KERNEL=="mmcblk[0-9]*", SUBSYSTEMS=="mmc", ENV{DEVTYPE}=="disk", ENV{MMC_TYPE}==
 KERNEL=="mmcblk[0-9]*", SUBSYSTEMS=="mmc", ENV{DEVTYPE}=="disk", ENV{MMC_TYPE}=="SDcombo", ENV{ID_DRIVE_FLASH_SD_COMBO}="1", ENV{ID_DRIVE_MEDIA_FLASH_SD}="1", ENV{ID_DRIVE_MEDIA_FLASH_SDIO}="1"
 # compatibility fallback in case of an unavailable MMC_TYPE attr
 KERNEL=="mmcblk[0-9]*", SUBSYSTEMS=="mmc", ENV{DEVTYPE}=="disk", ENV{MMC_TYPE}=="", ENV{ID_DRIVE_FLASH_SD}="1", ENV{ID_DRIVE_MEDIA_FLASH_SD}="1"
+
+# Match sda1 to mmcblk1 both of DEVTYPE==disk and SUBSYSTEM=="block"
+KERNEL=="mmcblk1*|sd[a-z][0-9]", SUBSYSTEM=="block", ENV{DEVTYPE}=="disk",  ENV{ID_DRIVE_FLASH_SD}="1", ENV{ID_DRIVE_MEDIA_FLASH_SD}="1"
+KERNEL=="mmcblk1*|sd[a-z][0-9]", SUBSYSTEM=="block", ENV{ID_FS_USAGE}=="filesystem", ACTION=="add", MODE="0660", TAG+="systemd", ENV{SYSTEMD_WANTS}="mount-sd@%k.service"
+
 # import ID_SERIAL and related for "mmcblk_boot" devices from its parent
 KERNEL=="mmcblk[0-9]boot[0-9]*", SUBSYSTEMS=="mmc", ENV{DEVTYPE}=="disk", IMPORT{parent}="ID_*"
 # ditto for memstick
diff --git a/data/Makefile.am b/data/Makefile.am
index 758644be..330dc54a 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -48,6 +48,7 @@ EXTRA_DIST =                                                                   \
 	80-udisks2.rules                                                       \
 	org.freedesktop.UDisks2.xml                                            \
 	builtin_mount_options.conf                                             \
+	mount-sd@.service                                                      \
 	$(systemdservice_in_files)                                             \
 	$(dbusservice_in_files)                                                \
 	$(dbusconf_in_files)                                                   \
diff --git a/data/mount-sd@.service b/data/mount-sd@.service
new file mode 100644
index 00000000..e0ef0d07
--- /dev/null
+++ b/data/mount-sd@.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Handle udisks sd mount
+After=udisks2.service dev-%i.device start-user-session.service
+Requisite=dev-%i.device
+Requires=udisks2.service
+Conflicts=rescue.target actdead.target factory-test.target
+
+[Service]
+Type=oneshot
+RemainAfterExit=yes
+ExecStart=/usr/bin/udisksctl-user mount -b /dev/%i
+ExecStop=/usr/bin/udisksctl unmount -b /dev/%i
diff --git a/tools/Makefile.am b/tools/Makefile.am
index 5f9a84ac..f4a1d287 100644
--- a/tools/Makefile.am
+++ b/tools/Makefile.am
@@ -36,6 +36,9 @@ udisksctl_LDADD =                                                              \
 	$(top_builddir)/udisks/libudisks2.la                                   \
 	$(NULL)
 
+extradir = $(bindir)
+extra_DATA = udisksctl-user
+
 # ------------------------------------------------------------------------------
 
 if ENABLE_DAEMON
diff --git a/tools/udisksctl-user b/tools/udisksctl-user
new file mode 100644
index 00000000..04a745d2
--- /dev/null
+++ b/tools/udisksctl-user
@@ -0,0 +1,4 @@
+#!/bin/sh
+ARGS=$@
+DEVICEUSER=$(loginctl list-sessions | grep seat0 | tr -s " " | cut -d " " -f 4)
+/bin/su -l $DEVICEUSER -c "/usr/bin/udisksctl $ARGS"
-- 
2.25.1

